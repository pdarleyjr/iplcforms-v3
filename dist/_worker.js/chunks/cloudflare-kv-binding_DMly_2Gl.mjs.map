{"version":3,"file":"cloudflare-kv-binding_DMly_2Gl.mjs","sources":["../../../node_modules/astro/node_modules/unstorage/drivers/utils/index.mjs","../../../node_modules/astro/node_modules/unstorage/drivers/utils/cloudflare.mjs","../../../node_modules/astro/node_modules/unstorage/drivers/cloudflare-kv-binding.mjs"],"sourcesContent":["export function defineDriver(factory) {\n  return factory;\n}\nexport function normalizeKey(key, sep = \":\") {\n  if (!key) {\n    return \"\";\n  }\n  return key.replace(/[:/\\\\]/g, sep).replace(/^[:/\\\\]|[:/\\\\]$/g, \"\");\n}\nexport function joinKeys(...keys) {\n  return keys.map((key) => normalizeKey(key)).filter(Boolean).join(\":\");\n}\nexport function createError(driver, message, opts) {\n  const err = new Error(`[unstorage] [${driver}] ${message}`, opts);\n  if (Error.captureStackTrace) {\n    Error.captureStackTrace(err, createError);\n  }\n  return err;\n}\nexport function createRequiredError(driver, name) {\n  if (Array.isArray(name)) {\n    return createError(\n      driver,\n      `Missing some of the required options ${name.map((n) => \"`\" + n + \"`\").join(\", \")}`\n    );\n  }\n  return createError(driver, `Missing required option \\`${name}\\`.`);\n}\n","import { createError } from \"./index.mjs\";\nexport function getBinding(binding) {\n  let bindingName = \"[binding]\";\n  if (typeof binding === \"string\") {\n    bindingName = binding;\n    binding = globalThis[bindingName] || globalThis.__env__?.[bindingName];\n  }\n  if (!binding) {\n    throw createError(\n      \"cloudflare\",\n      `Invalid binding \\`${bindingName}\\`: \\`${binding}\\``\n    );\n  }\n  for (const key of [\"get\", \"put\", \"delete\"]) {\n    if (!(key in binding)) {\n      throw createError(\n        \"cloudflare\",\n        `Invalid binding \\`${bindingName}\\`: \\`${key}\\` key is missing`\n      );\n    }\n  }\n  return binding;\n}\nexport function getKVBinding(binding = \"STORAGE\") {\n  return getBinding(binding);\n}\nexport function getR2Binding(binding = \"BUCKET\") {\n  return getBinding(binding);\n}\n","import { defineDriver, joinKeys } from \"./utils/index.mjs\";\nimport { getKVBinding } from \"./utils/cloudflare.mjs\";\nconst DRIVER_NAME = \"cloudflare-kv-binding\";\nexport default defineDriver((opts) => {\n  const r = (key = \"\") => opts.base ? joinKeys(opts.base, key) : key;\n  async function getKeys(base = \"\") {\n    base = r(base);\n    const binding = getKVBinding(opts.binding);\n    const keys = [];\n    let cursor = void 0;\n    do {\n      const kvList = await binding.list({ prefix: base || void 0, cursor });\n      keys.push(...kvList.keys);\n      cursor = kvList.list_complete ? void 0 : kvList.cursor;\n    } while (cursor);\n    return keys.map((key) => key.name);\n  }\n  return {\n    name: DRIVER_NAME,\n    options: opts,\n    getInstance: () => getKVBinding(opts.binding),\n    async hasItem(key) {\n      key = r(key);\n      const binding = getKVBinding(opts.binding);\n      return await binding.get(key) !== null;\n    },\n    getItem(key) {\n      key = r(key);\n      const binding = getKVBinding(opts.binding);\n      return binding.get(key);\n    },\n    setItem(key, value, topts) {\n      key = r(key);\n      const binding = getKVBinding(opts.binding);\n      return binding.put(\n        key,\n        value,\n        topts ? {\n          expirationTtl: topts?.ttl ? Math.max(topts.ttl, opts.minTTL ?? 60) : void 0,\n          ...topts\n        } : void 0\n      );\n    },\n    removeItem(key) {\n      key = r(key);\n      const binding = getKVBinding(opts.binding);\n      return binding.delete(key);\n    },\n    getKeys(base) {\n      return getKeys(base).then(\n        (keys) => keys.map((key) => opts.base ? key.slice(opts.base.length) : key)\n      );\n    },\n    async clear(base) {\n      const binding = getKVBinding(opts.binding);\n      const keys = await getKeys(base);\n      await Promise.all(keys.map((key) => binding.delete(key)));\n    }\n  };\n});\n"],"names":[],"mappings":"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","x_google_ignoreList":[0,1,2]}