{"version":3,"file":"plausible-proxy_CO7DzKo-.mjs","sources":["../../../src/lib/analytics/plausible-proxy.ts"],"sourcesContent":["/**\r\n * Plausible Analytics Proxy Handler for Cloudflare Workers\r\n * Provides privacy-preserving analytics by proxying requests through our domain\r\n */\r\n\r\nimport type { Request as CFRequest } from '@cloudflare/workers-types';\r\n\r\nexport interface PlausibleProxyConfig {\r\n  analyticsEnabled: boolean;\r\n  plausibleDomain?: string;\r\n  dataDomain?: string;\r\n}\r\n\r\n/**\r\n * Proxy handler for Plausible script\r\n */\r\nexport async function handlePlausibleScript(\r\n  request: CFRequest,\r\n  config: PlausibleProxyConfig\r\n): Promise<Response> {\r\n  // Return empty script if analytics disabled\r\n  if (!config.analyticsEnabled) {\r\n    return new Response('// Analytics disabled', {\r\n      status: 200,\r\n      headers: {\r\n        'Content-Type': 'application/javascript',\r\n        'Cache-Control': 'public, max-age=86400',\r\n      },\r\n    });\r\n  }\r\n\r\n  const plausibleDomain = config.plausibleDomain || 'plausible.io';\r\n  \r\n  try {\r\n    // Fetch the Plausible script\r\n    const scriptResponse = await fetch(`https://${plausibleDomain}/js/script.js`, {\r\n      headers: {\r\n        'User-Agent': request.headers.get('User-Agent') || '',\r\n      },\r\n    });\r\n\r\n    if (!scriptResponse.ok) {\r\n      throw new Error(`Failed to fetch Plausible script: ${scriptResponse.status}`);\r\n    }\r\n\r\n    const scriptContent = await scriptResponse.text();\r\n\r\n    // Return the script with proper caching headers\r\n    return new Response(scriptContent, {\r\n      status: 200,\r\n      headers: {\r\n        'Content-Type': 'application/javascript',\r\n        'Cache-Control': 'public, max-age=3600', // Cache for 1 hour\r\n        'Access-Control-Allow-Origin': '*',\r\n        'X-Content-Type-Options': 'nosniff',\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error('Error proxying Plausible script:', error);\r\n    return new Response('// Error loading analytics script', {\r\n      status: 200,\r\n      headers: {\r\n        'Content-Type': 'application/javascript',\r\n        'Cache-Control': 'public, max-age=300', // Cache error for 5 minutes\r\n      },\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Proxy handler for Plausible event API\r\n */\r\nexport async function handlePlausibleEvent(\r\n  request: CFRequest,\r\n  config: PlausibleProxyConfig\r\n): Promise<Response> {\r\n  // Return success if analytics disabled\r\n  if (!config.analyticsEnabled) {\r\n    return new Response(JSON.stringify({ status: 'disabled' }), {\r\n      status: 200,\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Access-Control-Allow-Origin': '*',\r\n      },\r\n    });\r\n  }\r\n\r\n  const plausibleDomain = config.plausibleDomain || 'plausible.io';\r\n\r\n  // Handle preflight requests\r\n  if (request.method === 'OPTIONS') {\r\n    return new Response(null, {\r\n      status: 204,\r\n      headers: {\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Methods': 'POST, OPTIONS',\r\n        'Access-Control-Allow-Headers': 'Content-Type, X-Forwarded-For',\r\n        'Access-Control-Max-Age': '86400',\r\n      },\r\n    });\r\n  }\r\n\r\n  if (request.method !== 'POST') {\r\n    return new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n      status: 405,\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Access-Control-Allow-Origin': '*',\r\n      },\r\n    });\r\n  }\r\n\r\n  try {\r\n    // Get the request body\r\n    const body = await request.text();\r\n    \r\n    // Get client IP for proper geo-location (Cloudflare provides this)\r\n    const clientIP = request.headers.get('CF-Connecting-IP') || \r\n                     request.headers.get('X-Forwarded-For')?.split(',')[0] || \r\n                     '';\r\n\r\n    // Forward the event to Plausible\r\n    const eventResponse = await fetch(`https://${plausibleDomain}/api/event`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'User-Agent': request.headers.get('User-Agent') || '',\r\n        'X-Forwarded-For': clientIP,\r\n        'Referer': request.headers.get('Referer') || '',\r\n      },\r\n      body: body,\r\n    });\r\n\r\n    // Return Plausible's response\r\n    return new Response(await eventResponse.text(), {\r\n      status: eventResponse.status,\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Cache-Control': 'no-cache, no-store, must-revalidate',\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error('Error proxying Plausible event:', error);\r\n    return new Response(JSON.stringify({ error: 'Failed to send event' }), {\r\n      status: 500,\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Access-Control-Allow-Origin': '*',\r\n      },\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Main proxy handler that routes requests\r\n */\r\nexport async function handlePlausibleProxy(\r\n  request: CFRequest,\r\n  env: any\r\n): Promise<Response> {\r\n  const url = new URL(request.url);\r\n  const config: PlausibleProxyConfig = {\r\n    analyticsEnabled: env.ANALYTICS_ENABLED === 'true' || env.ANALYTICS_ENABLED === true,\r\n    plausibleDomain: env.PLAUSIBLE_DOMAIN,\r\n    dataDomain: env.DATA_DOMAIN,\r\n  };\r\n\r\n  // Route based on path\r\n  if (url.pathname === '/a/js/plausible.js' || url.pathname === '/a/js/script.js') {\r\n    return handlePlausibleScript(request, config);\r\n  }\r\n\r\n  if (url.pathname === '/a/api/event') {\r\n    return handlePlausibleEvent(request, config);\r\n  }\r\n\r\n  // Return 404 for unknown analytics paths\r\n  return new Response('Not Found', {\r\n    status: 404,\r\n    headers: {\r\n      'Content-Type': 'text/plain',\r\n    },\r\n  });\r\n}"],"names":[],"mappings":"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"}