{"version":3,"file":"upload.astro.mjs","sources":["../../../../../src/pages/api/documents/upload.ts"],"sourcesContent":["import type { APIRoute } from 'astro';\r\nimport { nanoid } from 'nanoid';\r\nimport { checkRateLimit } from '../../../lib/ai';\r\nimport type { AIEnv } from '../../../lib/ai';\r\n\r\nexport const POST: APIRoute = async ({ request, locals }) => {\r\n  const env = (locals as any).runtime.env as unknown as AIEnv;\r\n  \r\n  try {\r\n    // Check rate limit\r\n    const clientId = request.headers.get('CF-Connecting-IP') || 'anonymous';\r\n    const rateLimitInfo = await checkRateLimit(clientId, env);\r\n    \r\n    if (!rateLimitInfo.allowed) {\r\n      return new Response(JSON.stringify({\r\n        error: 'Rate limit exceeded',\r\n        retryAfter: rateLimitInfo.retryAfter\r\n      }), {\r\n        status: 429,\r\n        headers: { \r\n          'Content-Type': 'application/json',\r\n          'X-RateLimit-Limit': (rateLimitInfo.limit || 60).toString(),\r\n          'X-RateLimit-Remaining': rateLimitInfo.remaining.toString(),\r\n          'X-RateLimit-Reset': rateLimitInfo.resetAt.toString()\r\n        }\r\n      });\r\n    }\r\n\r\n    const formData = await request.formData();\r\n    const files = formData.getAll('files') as File[];\r\n    \r\n    if (!files || files.length === 0) {\r\n      return new Response(JSON.stringify({ error: 'No files provided' }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n\r\n    // Use IPLC_AI service binding\r\n    const iplcAI = (env as any).IPLC_AI;\r\n    if (!iplcAI || typeof iplcAI.fetch !== 'function') {\r\n      return new Response(JSON.stringify({\r\n        error: 'AI service not available',\r\n        details: 'IPLC_AI service binding is not configured'\r\n      }), {\r\n        status: 503,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n\r\n    const uploadedDocuments = [];\r\n\r\n    for (const file of files) {\r\n      const documentId = nanoid();\r\n      const buffer = await file.arrayBuffer();\r\n      const text = await extractTextFromFile(file, buffer);\r\n      \r\n      // Split text into chunks with overlap\r\n      const chunks = splitTextIntoChunks(text, 600, 50);\r\n      \r\n      // Call the iplc-ai worker's /documents/upload endpoint\r\n      const uploadResponse = await iplcAI.fetch('https://iplc-ai.worker/documents/upload', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify({\r\n          documentId,\r\n          documentName: file.name,\r\n          documentType: file.type,\r\n          chunks: chunks\r\n        })\r\n      });\r\n      \r\n      if (!uploadResponse.ok) {\r\n        const error = await uploadResponse.text();\r\n        console.error(`Failed to upload ${file.name}:`, error);\r\n        uploadedDocuments.push({\r\n          id: documentId,\r\n          name: file.name,\r\n          error: error,\r\n          success: false\r\n        });\r\n        continue;\r\n      }\r\n      \r\n      const result = await uploadResponse.json();\r\n      \r\n      uploadedDocuments.push({\r\n        id: documentId,\r\n        name: file.name,\r\n        size: file.size,\r\n        type: file.type,\r\n        uploadedAt: new Date().toISOString(),\r\n        chunks: chunks.length,\r\n        vectorIds: result.vectorIds,\r\n        success: true\r\n      });\r\n    }\r\n\r\n    return new Response(JSON.stringify({\r\n      success: true,\r\n      documents: uploadedDocuments,\r\n      rateLimitInfo: {\r\n        limit: rateLimitInfo.limit,\r\n        remaining: rateLimitInfo.remaining,\r\n        resetAt: rateLimitInfo.resetAt\r\n      }\r\n    }), {\r\n      headers: { \r\n        'Content-Type': 'application/json',\r\n        'X-RateLimit-Limit': (rateLimitInfo.limit || 60).toString(),\r\n        'X-RateLimit-Remaining': rateLimitInfo.remaining.toString(),\r\n        'X-RateLimit-Reset': rateLimitInfo.resetAt.toString()\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Upload error:', error);\r\n    return new Response(JSON.stringify({ \r\n      error: 'Failed to upload documents',\r\n      details: error instanceof Error ? error.message : 'Unknown error'\r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n};\r\n\r\nasync function extractTextFromFile(file: File, buffer: ArrayBuffer): Promise<string> {\r\n  const type = file.type;\r\n  const decoder = new TextDecoder();\r\n  \r\n  // Handle text-based files\r\n  if (type.includes('text') || \r\n      type.includes('json') || \r\n      type.includes('csv') ||\r\n      type.includes('javascript') ||\r\n      type.includes('typescript') ||\r\n      type.includes('html') ||\r\n      type.includes('css') ||\r\n      type.includes('xml') ||\r\n      file.name.endsWith('.md') ||\r\n      file.name.endsWith('.txt') ||\r\n      file.name.endsWith('.js') ||\r\n      file.name.endsWith('.ts') ||\r\n      file.name.endsWith('.jsx') ||\r\n      file.name.endsWith('.tsx') ||\r\n      file.name.endsWith('.vue') ||\r\n      file.name.endsWith('.svelte')) {\r\n    return decoder.decode(buffer);\r\n  }\r\n  \r\n  // For PDF and other binary formats, we'd need a proper parser\r\n  // In production, you'd use libraries like pdf-parse\r\n  if (type.includes('pdf')) {\r\n    return `[PDF content from ${file.name} - parsing not implemented. Please convert to text format.]`;\r\n  }\r\n  \r\n  if (type.includes('doc')) {\r\n    return `[Document content from ${file.name} - parsing not implemented. Please convert to text format.]`;\r\n  }\r\n  \r\n  return `[Binary file ${file.name} - content extraction not supported. Please use text-based formats.]`;\r\n}\r\n\r\nfunction splitTextIntoChunks(text: string, chunkSize: number, overlap: number = 50): string[] {\r\n  const chunks: string[] = [];\r\n  \r\n  // If text is smaller than chunk size, return as single chunk\r\n  if (text.length <= chunkSize) {\r\n    return [text.trim()];\r\n  }\r\n  \r\n  // Split by sentences first\r\n  const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];\r\n  \r\n  let currentChunk = '';\r\n  let previousChunkEnd = '';\r\n  \r\n  for (const sentence of sentences) {\r\n    // If adding this sentence would exceed chunk size\r\n    if (currentChunk.length + sentence.length > chunkSize && currentChunk.length > 0) {\r\n      // Add the chunk with overlap from previous chunk\r\n      const chunkWithOverlap = previousChunkEnd + currentChunk;\r\n      chunks.push(chunkWithOverlap.trim());\r\n      \r\n      // Store end of current chunk for next overlap\r\n      const words = currentChunk.split(' ');\r\n      const overlapWords = Math.ceil(overlap / 6); // Assuming average word length of 6\r\n      previousChunkEnd = words.slice(-overlapWords).join(' ') + ' ';\r\n      \r\n      currentChunk = sentence;\r\n    } else {\r\n      currentChunk += ' ' + sentence;\r\n    }\r\n  }\r\n  \r\n  // Add the last chunk\r\n  if (currentChunk.trim()) {\r\n    const chunkWithOverlap = previousChunkEnd + currentChunk;\r\n    chunks.push(chunkWithOverlap.trim());\r\n  }\r\n  \r\n  return chunks;\r\n}"],"names":[],"mappings":"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"}