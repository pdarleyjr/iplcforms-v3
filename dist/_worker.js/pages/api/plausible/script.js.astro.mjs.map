{"version":3,"file":"script.js.astro.mjs","sources":["../../../../../src/pages/api/plausible/script.js.ts"],"sourcesContent":["import type { APIContext } from 'astro';\r\n\r\n/**\r\n * Proxy endpoint for Plausible Analytics script\r\n * Routes: GET /api/plausible/script.js\r\n * \r\n * This endpoint proxies requests to Plausible's script CDN,\r\n * allowing us to serve analytics from our own domain to avoid\r\n * ad blockers and improve privacy.\r\n */\r\nexport async function GET(context: APIContext): Promise<Response> {\r\n  const { locals } = context;\r\n  const env = locals.runtime?.env;\r\n\r\n  // Check if analytics is enabled via feature flag\r\n  const analyticsEnabled = env?.PLAUSIBLE_ENABLED === 'true';\r\n  \r\n  if (!analyticsEnabled) {\r\n    // Return a no-op script if analytics is disabled\r\n    return new Response(\r\n      '/* Plausible Analytics disabled */',\r\n      {\r\n        status: 200,\r\n        headers: {\r\n          'Content-Type': 'application/javascript',\r\n          'Cache-Control': 'public, max-age=86400', // Cache for 1 day\r\n        },\r\n      }\r\n    );\r\n  }\r\n\r\n  try {\r\n    // Fetch the Plausible script from their CDN\r\n    const plausibleResponse = await fetch('https://plausible.io/js/script.js', {\r\n      headers: {\r\n        'User-Agent': context.request.headers.get('User-Agent') || '',\r\n      },\r\n    });\r\n\r\n    if (!plausibleResponse.ok) {\r\n      throw new Error(`Failed to fetch Plausible script: ${plausibleResponse.status}`);\r\n    }\r\n\r\n    const scriptContent = await plausibleResponse.text();\r\n\r\n    // Return the script with appropriate caching headers\r\n    return new Response(scriptContent, {\r\n      status: 200,\r\n      headers: {\r\n        'Content-Type': 'application/javascript',\r\n        'Cache-Control': 'public, max-age=3600', // Cache for 1 hour\r\n        'X-Content-Type-Options': 'nosniff',\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error('Error proxying Plausible script:', error);\r\n    \r\n    // Return empty script on error to prevent breaking the page\r\n    return new Response(\r\n      '/* Error loading Plausible Analytics */',\r\n      {\r\n        status: 200,\r\n        headers: {\r\n          'Content-Type': 'application/javascript',\r\n          'Cache-Control': 'no-cache',\r\n        },\r\n      }\r\n    );\r\n  }\r\n}"],"names":[],"mappings":";;;AAUA,eAAsB,IAAI,OAAA,EAAwC;AAChE,EAAA,MAAM,EAAE,QAAO,GAAI,OAAA;AACnB,EAAA,MAAM,GAAA,GAAM,OAAO,OAAA,EAAS,GAAA;AAG5B,EAAA,MAAM,gBAAA,GAAmB,KAAK,iBAAA,KAAsB,MAAA;AAEpD,EAAA,IAAI,CAAC,gBAAA,EAAkB;AAErB,IAAA,OAAO,IAAI,QAAA;AAAA,MACT,oCAAA;AAAA,MACA;AAAA,QACE,MAAA,EAAQ,GAAA;AAAA,QACR,OAAA,EAAS;AAAA,UACP,cAAA,EAAgB,wBAAA;AAAA,UAChB,eAAA,EAAiB;AAAA;AAAA;AACnB;AACF,KACF;AAAA,EACF;AAEA,EAAA,IAAI;AAEF,IAAA,MAAM,iBAAA,GAAoB,MAAM,KAAA,CAAM,mCAAA,EAAqC;AAAA,MACzE,OAAA,EAAS;AAAA,QACP,cAAc,OAAA,CAAQ,OAAA,CAAQ,OAAA,CAAQ,GAAA,CAAI,YAAY,CAAA,IAAK;AAAA;AAC7D,KACD,CAAA;AAED,IAAA,IAAI,CAAC,kBAAkB,EAAA,EAAI;AACzB,MAAA,MAAM,IAAI,KAAA,CAAM,CAAA,kCAAA,EAAqC,iBAAA,CAAkB,MAAM,CAAA,CAAE,CAAA;AAAA,IACjF;AAEA,IAAA,MAAM,aAAA,GAAgB,MAAM,iBAAA,CAAkB,IAAA,EAAK;AAGnD,IAAA,OAAO,IAAI,SAAS,aAAA,EAAe;AAAA,MACjC,MAAA,EAAQ,GAAA;AAAA,MACR,OAAA,EAAS;AAAA,QACP,cAAA,EAAgB,wBAAA;AAAA,QAChB,eAAA,EAAiB,sBAAA;AAAA;AAAA,QACjB,wBAAA,EAA0B;AAAA;AAC5B,KACD,CAAA;AAAA,EACH,SAAS,KAAA,EAAO;AACd,IAAA,OAAA,CAAQ,KAAA,CAAM,oCAAoC,KAAK,CAAA;AAGvD,IAAA,OAAO,IAAI,QAAA;AAAA,MACT,yCAAA;AAAA,MACA;AAAA,QACE,MAAA,EAAQ,GAAA;AAAA,QACR,OAAA,EAAS;AAAA,UACP,cAAA,EAAgB,wBAAA;AAAA,UAChB,eAAA,EAAiB;AAAA;AACnB;AACF,KACF;AAAA,EACF;AACF;;;;;;;;;;;"}