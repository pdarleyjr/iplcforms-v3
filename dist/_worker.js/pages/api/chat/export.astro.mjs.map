{"version":3,"file":"export.astro.mjs","sources":["../../../../../src/pages/api/chat/export.ts"],"sourcesContent":["import type { APIRoute } from 'astro';\r\n\r\nexport const runtime = 'edge';\r\n\r\ninterface ExportRequest {\r\n  conversationId: string;\r\n  format: 'markdown' | 'json';\r\n}\r\n\r\ninterface Message {\r\n  role: 'user' | 'assistant';\r\n  content: string;\r\n  timestamp: string;\r\n  citations?: Array<{\r\n    id: number;\r\n    documentName: string;\r\n    text: string;\r\n    score: number;\r\n  }>;\r\n}\r\n\r\nimport { withRBAC } from '@/lib/middleware/rbac-middleware';\r\nexport const POST: APIRoute = withRBAC(['clinician','admin'], async ({ request, locals }) => {\r\n  try {\r\n    const { env } = locals.runtime;\r\n    const body = await request.json() as ExportRequest;\r\n    \r\n    if (!body.conversationId) {\r\n      return new Response(JSON.stringify({ \r\n        error: 'Conversation ID is required' \r\n      }), { \r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n    \r\n    // Retrieve conversation history from KV\r\n    const historyData = await env.KV.get(`chat:history:${body.conversationId}`);\r\n    \r\n    if (!historyData) {\r\n      return new Response(JSON.stringify({ \r\n        error: 'Conversation not found' \r\n      }), { \r\n        status: 404,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n    \r\n    const messages: Message[] = JSON.parse(historyData);\r\n    \r\n    if (body.format === 'json') {\r\n      // Return raw JSON format\r\n      return new Response(JSON.stringify({\r\n        conversationId: body.conversationId,\r\n        exportedAt: new Date().toISOString(),\r\n        messages\r\n      }), {\r\n        status: 200,\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Content-Disposition': `attachment; filename=\"conversation-${body.conversationId}.json\"`\r\n        }\r\n      });\r\n    }\r\n    \r\n    // Generate Markdown format\r\n    let markdown = `# AI Chat Conversation\\n\\n`;\r\n    markdown += `**Exported:** ${new Date().toLocaleString()}\\n`;\r\n    markdown += `**Conversation ID:** ${body.conversationId}\\n\\n`;\r\n    markdown += `---\\n\\n`;\r\n    \r\n    // Process each message\r\n    messages.forEach((message, index) => {\r\n      const timestamp = new Date(message.timestamp).toLocaleTimeString();\r\n      \r\n      if (message.role === 'user') {\r\n        markdown += `## ðŸ‘¤ User (${timestamp})\\n\\n`;\r\n        markdown += `${message.content}\\n\\n`;\r\n      } else {\r\n        markdown += `## ðŸ¤– AI Assistant (${timestamp})\\n\\n`;\r\n        \r\n        // Replace citation markers with markdown footnotes\r\n        let content = message.content;\r\n        const footnotes: string[] = [];\r\n        \r\n        if (message.citations && message.citations.length > 0) {\r\n          content = content.replace(/\\^\\[(\\d+)\\]/g, (match, num) => {\r\n            const citation = message.citations?.find(c => c.id === parseInt(num));\r\n            if (citation) {\r\n              footnotes.push(`[^${num}]: From \"${citation.documentName}\" - ${citation.text.substring(0, 200)}...`);\r\n              return `[^${num}]`;\r\n            }\r\n            return match;\r\n          });\r\n        }\r\n        \r\n        markdown += `${content}\\n\\n`;\r\n        \r\n        // Add footnotes if any\r\n        if (footnotes.length > 0) {\r\n          markdown += `### Sources\\n\\n`;\r\n          footnotes.forEach(footnote => {\r\n            markdown += `${footnote}\\n\\n`;\r\n          });\r\n        }\r\n      }\r\n      \r\n      // Add separator between Q&A pairs\r\n      if (index < messages.length - 1) {\r\n        markdown += `---\\n\\n`;\r\n      }\r\n    });\r\n    \r\n    // Return markdown file\r\n    return new Response(markdown, {\r\n      status: 200,\r\n      headers: {\r\n        'Content-Type': 'text/markdown; charset=utf-8',\r\n        'Content-Disposition': `attachment; filename=\"conversation-${body.conversationId}.md\"`\r\n      }\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('Error exporting conversation:', error);\r\n    return new Response(JSON.stringify({ \r\n      error: 'Failed to export conversation' \r\n    }), { \r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n});\r\n\r\n// GET endpoint to retrieve available export formats\r\nexport const GET: APIRoute = withRBAC(['clinician','admin'], async () => {\r\n  return new Response(JSON.stringify({\r\n    formats: [\r\n      {\r\n        id: 'markdown',\r\n        name: 'Markdown',\r\n        extension: '.md',\r\n        mimeType: 'text/markdown'\r\n      },\r\n      {\r\n        id: 'json',\r\n        name: 'JSON',\r\n        extension: '.json',\r\n        mimeType: 'application/json'\r\n      }\r\n    ]\r\n  }), {\r\n    status: 200,\r\n    headers: { 'Content-Type': 'application/json' }\r\n  });\r\n});"],"names":[],"mappings":"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"}