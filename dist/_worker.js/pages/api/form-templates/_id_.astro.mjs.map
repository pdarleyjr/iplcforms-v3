{"version":3,"file":"_id_.astro.mjs","sources":["../../../../../src/pages/api/form-templates/[id].ts"],"sourcesContent":["import { FormTemplateService } from \"@/lib/services/form_template\";\r\nimport { authenticate, authorize } from \"@/lib/middleware/rbac-middleware\";\r\nimport { PERMISSIONS } from \"@/lib/utils/rbac\";\r\nimport { FormTemplateSchema, validateRequest } from \"@/lib/schemas/api-validation\";\r\nimport type { APIRoute } from \"astro\";\r\nimport { withPerformanceMonitoring } from \"@/lib/utils/performance-wrapper\";\r\n\r\nconst getHandler: APIRoute = async (context) => {\r\n  const { locals, params } = context;\r\n  const { id } = params;\r\n  const { DB } = (locals as any).runtime.env;\r\n\r\n  if (!id) {\r\n    return Response.json({ message: \"Template ID is required\" }, { status: 400 });\r\n  }\r\n\r\n  // Authenticate request\r\n  const authResult = await authenticate(context);\r\n  if (authResult instanceof Response) return authResult;\r\n\r\n  // Authorize for read access\r\n  const authzMiddleware = authorize(PERMISSIONS.READ, 'form_templates');\r\n  const authzResult = await authzMiddleware(authResult);\r\n  if (authzResult instanceof Response) return authzResult;\r\n\r\n  const formTemplateService = new FormTemplateService(DB);\r\n  const template = await formTemplateService.getById(Number(id));\r\n\r\n  if (!template) {\r\n    return Response.json({ message: \"Form template not found\" }, { status: 404 });\r\n  }\r\n\r\n  return Response.json({ template });\r\n};\r\n\r\nconst putHandler: APIRoute = async (context) => {\r\n  const { locals, params, request } = context;\r\n  const { id } = params;\r\n  const { DB } = (locals as any).runtime.env;\r\n\r\n  if (!id) {\r\n    return Response.json({ message: \"Template ID is required\" }, { status: 400 });\r\n  }\r\n\r\n  // Authenticate request\r\n  const authResult = await authenticate(context);\r\n  if (authResult instanceof Response) return authResult;\r\n\r\n  // Authorize for update access\r\n  const authzMiddleware = authorize(PERMISSIONS.UPDATE, 'form_templates');\r\n  const authzResult = await authzMiddleware(authResult);\r\n  if (authzResult instanceof Response) return authzResult;\r\n\r\n  // Parse and validate request body\r\n  const body = await request.json();\r\n  const validationResult = validateRequest(FormTemplateSchema.partial(), body);\r\n  if (!validationResult.success) {\r\n    return Response.json({ errors: validationResult.errors }, { status: 400 });\r\n  }\r\n\r\n  const formTemplateService = new FormTemplateService(DB);\r\n\r\n  try {\r\n    const template = await formTemplateService.update(Number(id), validationResult.data as {\r\n      name?: string;\r\n      description?: string;\r\n      category?: string;\r\n      form_config?: object;\r\n      metadata?: object;\r\n    });\r\n    \r\n    if (!template) {\r\n      return Response.json({ message: \"Form template not found\" }, { status: 404 });\r\n    }\r\n\r\n    return Response.json({\r\n      message: \"Form template updated successfully\",\r\n      template,\r\n      success: true,\r\n    });\r\n  } catch (error) {\r\n    return Response.json(\r\n      {\r\n        message: error instanceof Error ? error.message : \"Failed to update form template\",\r\n        success: false,\r\n      },\r\n      { status: 500 },\r\n    );\r\n  }\r\n};\r\n\r\nconst deleteHandler: APIRoute = async (context) => {\r\n  const { locals, params } = context;\r\n  const { id } = params;\r\n  const { DB } = (locals as any).runtime.env;\r\n\r\n  if (!id) {\r\n    return Response.json({ message: \"Template ID is required\" }, { status: 400 });\r\n  }\r\n\r\n  // Authenticate request\r\n  const authResult = await authenticate(context);\r\n  if (authResult instanceof Response) return authResult;\r\n\r\n  // Authorize for delete access\r\n  const authzMiddleware = authorize(PERMISSIONS.DELETE, 'form_templates');\r\n  const authzResult = await authzMiddleware(authResult);\r\n  if (authzResult instanceof Response) return authzResult;\r\n\r\n  const formTemplateService = new FormTemplateService(DB);\r\n\r\n  try {\r\n    const success = await formTemplateService.delete(Number(id));\r\n    \r\n    if (!success) {\r\n      return Response.json({ message: \"Form template not found\" }, { status: 404 });\r\n    }\r\n\r\n    return Response.json({\r\n      message: \"Form template deleted successfully\",\r\n      success: true,\r\n    });\r\n  } catch (error) {\r\n    return Response.json(\r\n      {\r\n        message: error instanceof Error ? error.message : \"Failed to delete form template\",\r\n        success: false,\r\n      },\r\n      { status: 500 },\r\n    );\r\n  }\r\n};\r\n\r\nexport const GET = withPerformanceMonitoring(getHandler, 'form-templates:get');\r\nexport const PUT = withPerformanceMonitoring(putHandler, 'form-templates:update');\r\nexport const DELETE = withPerformanceMonitoring(deleteHandler, 'form-templates:delete');"],"names":[],"mappings":"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"}