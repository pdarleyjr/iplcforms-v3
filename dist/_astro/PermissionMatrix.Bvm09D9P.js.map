{"version":3,"file":"PermissionMatrix.Bvm09D9P.js","sources":["../../src/components/admin/PermissionMatrix.tsx"],"sourcesContent":["import React, { useState, useEffect } from 'react';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../ui/card';\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '../ui/table';\r\nimport { Checkbox } from '../ui/checkbox';\r\nimport { Badge } from '../ui/badge';\r\nimport { Button } from '../ui/button';\r\nimport { Alert, AlertDescription } from '../ui/alert';\r\nimport { Loader2, Lock, Save, AlertCircle } from 'lucide-react';\r\nimport { ROLES, RESOURCES, PERMISSIONS } from '../../lib/utils/rbac';\r\n\r\ninterface PermissionData {\r\n  role: string;\r\n  permissions: {\r\n    [resource: string]: string[];\r\n  };\r\n}\r\n\r\nexport function PermissionMatrix() {\r\n  const [permissionData, setPermissionData] = useState<PermissionData[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [saving, setSaving] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [modifiedPermissions, setModifiedPermissions] = useState<Set<string>>(new Set());\r\n\r\n  useEffect(() => {\r\n    fetchPermissions();\r\n  }, []);\r\n\r\n  const fetchPermissions = async () => {\r\n    try {\r\n      setLoading(true);\r\n      setError(null);\r\n      \r\n      const response = await fetch('/api/admin/permissions', {\r\n        headers: {\r\n          'X-Customer-ID': localStorage.getItem('customerId') || ''\r\n        }\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error('Failed to fetch permissions');\r\n      }\r\n\r\n      const data = await response.json() as { permissions: PermissionData[] };\r\n      setPermissionData(data.permissions);\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : 'An error occurred');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const hasPermission = (role: string, resource: string, permission: string): boolean => {\r\n    const roleData = permissionData.find(p => p.role === role);\r\n    return roleData?.permissions[resource]?.includes(permission) || false;\r\n  };\r\n\r\n  const togglePermission = (role: string, resource: string, permission: string) => {\r\n    const updatedData = permissionData.map(roleData => {\r\n      if (roleData.role === role) {\r\n        const resourcePermissions = roleData.permissions[resource] || [];\r\n        const hasPermission = resourcePermissions.includes(permission);\r\n        \r\n        return {\r\n          ...roleData,\r\n          permissions: {\r\n            ...roleData.permissions,\r\n            [resource]: hasPermission\r\n              ? resourcePermissions.filter(p => p !== permission)\r\n              : [...resourcePermissions, permission]\r\n          }\r\n        };\r\n      }\r\n      return roleData;\r\n    });\r\n\r\n    setPermissionData(updatedData);\r\n    setModifiedPermissions(new Set([...modifiedPermissions, `${role}-${resource}-${permission}`]));\r\n  };\r\n\r\n  const savePermissions = async () => {\r\n    try {\r\n      setSaving(true);\r\n      setError(null);\r\n\r\n      const response = await fetch('/api/admin/permissions', {\r\n        method: 'PUT',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'X-Customer-ID': localStorage.getItem('customerId') || ''\r\n        },\r\n        body: JSON.stringify({ permissions: permissionData })\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error('Failed to save permissions');\r\n      }\r\n\r\n      setModifiedPermissions(new Set());\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : 'An error occurred');\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center p-8\">\r\n        <Loader2 className=\"h-8 w-8 animate-spin\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <Card>\r\n      <CardHeader>\r\n        <CardTitle className=\"flex items-center gap-2\">\r\n          <Lock className=\"h-5 w-5\" />\r\n          Permission Matrix\r\n        </CardTitle>\r\n        <CardDescription>\r\n          Configure permissions for each role across different resources\r\n        </CardDescription>\r\n      </CardHeader>\r\n      <CardContent>\r\n        {error && (\r\n          <Alert variant=\"destructive\" className=\"mb-4\">\r\n            <AlertCircle className=\"h-4 w-4\" />\r\n            <AlertDescription>{error}</AlertDescription>\r\n          </Alert>\r\n        )}\r\n\r\n        <div className=\"overflow-x-auto\">\r\n          <Table className=\"min-w-[800px]\">\r\n            <TableHeader>\r\n              <TableRow>\r\n                <TableHead className=\"sticky left-0 bg-background\">Resource</TableHead>\r\n                {Object.keys(PERMISSIONS).map(permission => (\r\n                  <TableHead key={permission} className=\"text-center\">\r\n                    <div className=\"flex flex-col items-center gap-1\">\r\n                      <span className=\"text-xs font-medium uppercase\">\r\n                        {permission}\r\n                      </span>\r\n                    </div>\r\n                  </TableHead>\r\n                ))}\r\n              </TableRow>\r\n            </TableHeader>\r\n            <TableBody>\r\n              {Object.keys(ROLES).map(role => (\r\n                <React.Fragment key={role}>\r\n                  <TableRow className=\"bg-muted/50\">\r\n                    <TableCell colSpan={Object.keys(PERMISSIONS).length + 1}>\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <Badge variant={role === 'admin' ? 'destructive' : 'default'}>\r\n                          {role.toUpperCase()}\r\n                        </Badge>\r\n                        <span className=\"text-sm text-muted-foreground\">\r\n                          {role === 'admin' && '(Has all permissions)'}\r\n                          {role === 'patient' && '(Limited to own data)'}\r\n                        </span>\r\n                      </div>\r\n                    </TableCell>\r\n                  </TableRow>\r\n                  {Object.keys(RESOURCES).map(resource => (\r\n                    <TableRow key={`${role}-${resource}`}>\r\n                      <TableCell className=\"sticky left-0 bg-background font-medium\">\r\n                        {resource.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase())}\r\n                      </TableCell>\r\n                      {Object.keys(PERMISSIONS).map(permission => {\r\n                        const isAllowed = hasPermission(role, resource, permission);\r\n                        const isModified = modifiedPermissions.has(`${role}-${resource}-${permission}`);\r\n                        const isDisabled = role === 'admin' || \r\n                          (role === 'patient' && !['own_submissions', 'own_profile'].includes(resource));\r\n                        \r\n                        return (\r\n                          <TableCell key={permission} className=\"text-center\">\r\n                            <div className=\"flex justify-center\">\r\n                              <Checkbox\r\n                                checked={isAllowed}\r\n                                disabled={isDisabled}\r\n                                onCheckedChange={() => togglePermission(role, resource, permission)}\r\n                                className={isModified ? 'border-blue-500' : ''}\r\n                              />\r\n                            </div>\r\n                          </TableCell>\r\n                        );\r\n                      })}\r\n                    </TableRow>\r\n                  ))}\r\n                </React.Fragment>\r\n              ))}\r\n            </TableBody>\r\n          </Table>\r\n        </div>\r\n\r\n        {modifiedPermissions.size > 0 && (\r\n          <div className=\"mt-4 flex justify-end\">\r\n            <Button\r\n              onClick={savePermissions}\r\n              disabled={saving}\r\n              className=\"flex items-center gap-2\"\r\n            >\r\n              {saving ? (\r\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n              ) : (\r\n                <Save className=\"h-4 w-4\" />\r\n              )}\r\n              Save Changes ({modifiedPermissions.size})\r\n            </Button>\r\n          </div>\r\n        )}\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}"],"names":["PermissionMatrix","permissionData","setPermissionData","useState","loading","setLoading","saving","setSaving","error","setError","modifiedPermissions","setModifiedPermissions","useEffect","fetchPermissions","response","data","err","hasPermission","role","resource","permission","p","togglePermission","updatedData","roleData","resourcePermissions","savePermissions","jsx","Loader2","Card","jsxs","CardHeader","CardTitle","Lock","CardDescription","CardContent","Alert","AlertCircle","AlertDescription","Table","TableHeader","TableRow","TableHead","PERMISSIONS","TableBody","ROLES","React","TableCell","Badge","RESOURCES","l","isAllowed","isModified","isDisabled","Checkbox","Button","Save"],"mappings":"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"}